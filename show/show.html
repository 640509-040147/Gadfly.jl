<!DOCTYPE html>
<html>
	<head>
		<title>Gadfly Plot</title>
		<link rel="stylesheet" href="css/jquery-ui-1.10.3.custom.css" />
		<link rel="stylesheet" href="css/bootstrap.css" />
		<link rel="stylesheet" href="css/show.css" />
		<script src="../src/gadfly.js"></script>
		<script src="js/d3.min.js"></script>
		<script src="js/jquery-2.0.2.min.js"></script>
		<script src="js/jquery-ui-1.10.3.custom.js"></script>
        <script src="js/bootstrap.js"></script>
        <script src="js/Blob.js"></script>
        <script src="js/FileSaver.js"></script>
        <script src="js/base64.js"></script>
		<script>
		// Gadfly uses millimeters by default where most of the dom/javascript
		// stuff uses pixels. Figure out how to transform between the two.
		var get_px_per_mm = function() {
			var div = document.createElement("div");
			div.style.width = "1mm";
			var body = document.getElementsByTagName("body")[0];
			body.appendChild(div);
			var ppm = document.defaultView.getComputedStyle(div, null)
			                              .getPropertyValue('width');
            body.removeChild(div);
			return parseFloat(ppm);
		}
		</script>
	</head>
	<body>
		<div class="tabbable">
			<ul class="nav nav-tabs">
				<li class="active"><a href="#view" data-toggle="tab">View</a></li>
				<li><a href="#edit" data-toggle="tab">Edit</a></li>
				<li><a href="#export" data-toggle="tab">Export</a></li>
			</ul>

            <div class="tab-content">
                <!--Where the plot is rendered.-->
                <div id="view" class="tab-pane active span8">
                </div>

                <!-- Controls for making non-trivial changes to the plot. -->
                <div id="edit" class="tab-pane span8">
                    TODO: controls for modifying the plot object.
                </div>

                <!--Controls for exporting the current viewed plot to a files.-->
                <div id="export" class="tab-pane span8">
                    <script>
                        var export_current_ext = "svg";

                        export_format_change = function() {
                            var ext = $("#export_format_select").val();
                            var name = $("#export_name_input").val().split(".");

                            if (name.length > 1 &&
                                name[name.length-1] == export_current_ext) {
                                name[name.length-1] = ext;
                                $("#export_name_input").val(name.join("."));
                            }

                            export_current_ext = ext;
                        };

                        export_button_click = function() {
                            console.info("sending export request");
                            var export_backend = {
                                "type": export_current_ext.toUpperCase(),
                                "width": backend.width,
                                "height": backend.height};
                            sendreq("export", export_backend);
                        };
                    </script>

                    <label>Save As:
                        <input id="export_name_input"
                                type="text"
                                value="plot.svg" />
                    </label>
                    <label>Format:
                        <select id="export_format_select" onchange="export_format_change()">
                            <option>svg</option>
                            <option>png</option>
                            <option>ps</option>
                            <option>pdf</option>
                        </select>
                    </label>
                    <button class="btn" onclick="export_button_click()">Save</button>
                </div>
            </div>
		</div>

		<script>
			var ppm = get_px_per_mm();
			var conn = new WebSocket("ws://localhost:8080")
			var plot = null;
			var backend = null;

			conn.onmessage = function(msg) {
				console.info("message received")
				var msgcontents = JSON.parse(msg.data);

                // Handle special messages meant to be sent to a file.
                if (msgcontents["msg"] == "export") {
                    var mime = "";
                    if (export_current_ext == "svg") {
                        mime = "image/svg+xml";
                    }
                    else if (export_current_ext == "png") {
                        mime = "image/png";
                    }
                    else if (export_current_ext == "pdf") {
                        mime = "application/pdf";
                    }
                    else if (export_current_ext == "ps") {
                        mime = "application/postscript";
                    }

                    data = base64DecToArr(msgcontents["graphic"]);
                    blob = new Blob([data],
                                    {"type": mime});
                    saveAs(blob, $("#export_name_input").val());
                    return;
                }

				jQuery.globalEval(atob(msgcontents["graphic"]));
				$("#view svg").remove();
				draw("#view");
				$("svg").attr("preserveAspectRatio", "none");
				plot = msgcontents["plot"];
				backend = msgcontents["backend"];
				$("#view").resizable(
					{
						autoHide: true,
                        start: function(event, ui) {
                            var div = $("#view");
                            div.css("border", "1px dashed #ccc");
                        },
						stop: function(event, ui) {
							var div = $("#view");
							backend.width = parseFloat(div.css("width")) / ppm;
							backend.height = parseFloat(div.css("height")) / ppm;
                            div.css("border", "none");
							sendreq("update", backend);
						},
						resize: function(event, ui) {
							$(this).css("left",
								(($(window).width() - ui.size.width) / 2) + "px");
							$("#view").css("width", ui.size.width + "px");
							$("#view").css("height", ui.size.height + "px");

							var svg = $("#view > svg");
							svg.attr("width", ui.size.width + "px");
							svg.attr("height", ui.size.height + "px");
						}
					});

				// size the container arround the plot
				view = $("#view");
				view.css("width", backend.width + "mm");
				view.css("height", backend.height + "mm");

				// re-center the container
				view.css("left", (($(window).width() - backend.width * ppm) / 2) + "px");
			}

			var sendreq = function(msg, backend) {
				console.info("sending request")
				msg = JSON.stringify({"msg": msg, "plot": plot, "backend": backend});
				conn.send(msg);
			}


            $("#tabs").click(function (e) {
                e.preventDefault();
                $(this).tab("show");
            });
		</script>

		<!-- TODO
			Exporting:
			I think the solution will look like this:
				1. Ask the server for a SVG/PNG/PS/PDF copy.
				2. The server responds with base64 encoded data.
				3. Client-side creates a data URI. When clicked

			Here's some things we should be able to do:
				1. Export the plot to an image.
				2. Modify the plot specification by:
					Resizing
					Adding/removing plot elements.
		 -->
	</body>
</html>
